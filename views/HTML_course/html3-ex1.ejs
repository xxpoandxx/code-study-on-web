<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="../../../stylesheets/exercise.css">
    <script src="/javascripts/localstorage.js"></script>
    <title>2.[演習ページ]文章を書いてみよう！《pタグ・hタグ》</title>
</head>

<body>
    <h1>2. [演習ページ] 文章を書いてみよう！《pタグ・hタグ》</h1>
    <div class="column-main">
        <div class="talk">
            <div class="balloon">
                <figure class="balloon-image-left">
                    <img src="/images/piyo.png" alt="せんせい">
                    <figcaption class="balloon-image-description">せんせい</figcaption>
                </figure>
                <div class="balloon-text-right">
                    <p><span style="font-size:20px;font-weight:bold;">[演習1]</span><br>HTMLファイルに、<br>h1タグを使って「<span
                            style="color:red">ぴよぴよ</span>」と入力してください。</p>
                </div>
            </div>
            
            <div class="balloon">
                <figure class="balloon-image-left">
                    <img src="/images/piyo.png" alt="せんせい">
                    <figcaption class="balloon-image-description">せんせい</figcaption>
                </figure>
                <div class="balloon-text-right">
                    <p><span style="font-size:20px;font-weight:bold;">[演習2]</span><br>HTMLファイルに、<br>pタグを使って「<span
                            style="color:red">ひよこの豆知識を教えます</span>」と入力してください。</p>
                </div>
            </div>
            <div class="balloon">
                <figure class="balloon-image-left">
                    <img src="/images/piyo.png" alt="せんせい">
                    <figcaption class="balloon-image-description">せんせい</figcaption>
                </figure>
                <div class="balloon-text-right">
                    <p>完成したら、"REFRESH!"ボタンを押してください。</p>
                </div>
            </div>
        </div>
        <h2>HTML</h2>
        <div id="html-editor" style="background-color: #fff;"></div>

        <h2>CSS</h2>
        <div id="css-editor" style="background-color: #fff;"></div>

        <h2>JavaScript</h2>
        <div id="javascript-editor" style="background-color: #fff;"></div>


        <button id="downloadButton" class="course-button">
            <i class="fa-solid fa-download"></i>
        </button>
        <button id="imagePlus"><i class="fa-solid fa-plus"></i></button>
        <button id="imageMinus"><i class="fa-solid fa-minus"></i></button>
        <div id="imagebox">
        <input type="file" class="uploadButton" accept="image/png, image/jpeg" id="initialUploadButton" multiple>
     </div>


        <button id="doPreviewUpdate" type="button" class="course-button"
            style="margin:30px 280px;display:block;">REFRESH!
        </button>
        <button id="doPreviewSave" type="button" class="course-button" style="margin:30px 280px;display:block;" >SAVE!</button>

        <a href="html3#ex1" class="course-button" style="margin:auto;">トークに戻る</a>
    </div>
    <div class="column-sub">
        <iframe id="preview" style="background-color:#fff; position:fixed;"></iframe>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const target = document.getElementById("preview");

            // (1)ページ読み込み時に一度だけスクロール量を出力
            let scroll_y = window.scrollY;
            console.log(scroll_y);

            // (2)スクロールするたびにスクロール量を出力
            window.addEventListener('scroll', (event) => {
                let scroll_y = window.scrollY;
                if (scroll_y > 165) {
                    target.classList.add("fullsize");
                    target.style.height = `calc(100vh - 18px)`
                } else {
                    target.classList.remove("fullsize");
                    target.style.height = `calc(100vh - 18px - 165px + ${scroll_y}px)`
                }
            });
        })

         // 画像をアップロードする関数
         //change(状態が変わったら) click→クリックしただけで反応
        // document.addEventListener('change',uploadImage);
        
        // let file;
        // let uri;

        // function uploadImage(e) {   
        //     console.log(e.target)  
        //     file = e.target.files[0]
        //     var reader = new FileReader()
        //     reader.onload = function (e) {
        //         uri = e.target.result
        //         hogehoge(file, uri)
        //     }
        //     reader.readAsDataURL(file)
        //     console.log(file, uri)
        //         }

        const imagePlus = ()=>{
            const box = document.getElementById('imagebox');
            const input = document.createElement('input');
            input.classList.add('uploadButton');
            input.accept="image/png, image/jpeg";
            input.type='file';
            input.multiple=true;
            input.addEventListener('change',imageboxonChange);
            box.appendChild(input);
        } 

        document.getElementById('imagePlus').addEventListener('click',imagePlus);

        const imageMinus =()=>{
            const box = document.getElementById('imagebox');
            box.lastElementChild.remove();
            // const inputList = box.getElementsByClassName('uploadButton');
            // inputList[inputList.length-1].remove();
        }
        document.getElementById('imageMinus').addEventListener('click',imageMinus);

        const imageboxonChange =(e)=>{
            const files = e.target.files
            for (let i = 0; i< files.length; i++) {
                const file = files[i];
                const reader = new FileReader()
                reader.onload = (x)=>{
                    const uri = x.target.result
                    const fileName = file.name
                    const fileType = file.type
                    hogehoge(fileName,fileType,uri);
                }
            }
        }
        document.getElementById('initialUploadButton').addEventListener('change',imageboxonChange);
    </script>
    </div>

    <script type="importmap">
        {
            "imports": {
                "codemirror/": "https://deno.land/x/codemirror_esm@v6.0.1/esm/"
            }
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js" inline>
    </script>

    <script async type="module" inline>
        import { basicSetup } from "codemirror/codemirror/dist/index.js"
        import { html } from "codemirror/lang-html/dist/index.js";
        import { css } from "codemirror/lang-css/dist/index.js";
        import { javascript } from "codemirror/lang-javascript/dist/index.js";
        import { EditorState } from "codemirror/state/dist/index.js";
        import { EditorView, keymap } from 'codemirror/view/dist/index.js';

        //import 'https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js';

        const htmlEditor = document.getElementById('html-editor');
        const cssEditor = document.getElementById('css-editor');
        const javascriptEditor = document.getElementById('javascript-editor');
        const previewIframe = document.getElementById('preview');

        // 各エディタのプレースホルダー
        let savedCodes = hugahuga('html3-ex1');
        const placeholderCodes = {
            html: savedCodes.html??`<!-- ここにhtmlコードを書いてください -->
            
            
            `,
            css: savedCodes.css??`/* ここにcssコードを書いてください */
            
            
            
            `,
            javascript: savedCodes.js??`// ここにjavascriptコードを書いてください
            
            
            
            `
        };


        let reList = [];
        const eventHandlers = EditorView.domEventHandlers({
            blur(event, view){
                doPreviewSave();
                updatePreview();
            },
            input(event, view){
                if (reList.length > 0) {
                    for (let i = 0; i < reList.length; i++) {
                        clearTimeout(reList[i]);
                    }
                    reList = [];
                }
                const nextRe =setTimeout(() => {
                    doPreviewSave();
                    updatePreview();
                },1000)
                reList.push(nextRe);
            }
        });



        // Code Mirror セットアップ
        const htmlView = new EditorView({
            parent: htmlEditor,
            state: EditorState.create({
                doc: placeholderCodes.html,
                extensions: [basicSetup, html(), eventHandlers]
            })
        });

        const cssView = new EditorView({
            parent: cssEditor,
            state: EditorState.create({
                doc: placeholderCodes.css,
                extensions: [basicSetup, css(), eventHandlers]
            })
        });

        const javascriptView = new EditorView({
            parent: javascriptEditor,
            state: EditorState.create({
                doc: placeholderCodes.javascript,
                extensions: [basicSetup, javascript(), eventHandlers]
            })
        });

        // ブラウザに戻ってきた時にすぐ、元書いてあるコードがプレビューに表示させる
        updatePreview();

        // State 取得用
        function getCodes() {
            const html = htmlView.state.doc.toString();
            const css = cssView.state.doc.toString();
            const javascript= javascriptView.state.doc.toString();
            
            return {
                html, css, javascript,
                doc: `<!DOCTYPE html>
<html>\n<head>\n<meta charset="UTF-8">
<style>\n${css}\n</style>\n</head>
<body>\n${html}\n<body>\n</html>`,
            };
        }

        // プレビュー
        function updatePreview() {
            const codes = getCodes();

            const file = getHogehoge(); // LS から保存したファイルを取得
            // file データがなければ、ただ表示するだけ
            if (file === null) {
                previewIframe.srcdoc = codes.doc;
                return;
            }
            
            // file データありなら、IMG タグ置き換え
            const replaced = codes.doc.replaceAll(file.name, file.uri);
            previewIframe.srcdoc = replaced;
        }

        function doPreviewSave() {
            const codes = getCodes();
            setCode(`html3-ex1`, codes.html, codes.css, codes.javascript);
        }

        document.getElementById("doPreviewSave").addEventListener("click", doPreviewSave);

        // window.setInterval(updatePreview, 100);
        document.getElementById("doPreviewUpdate").addEventListener("click", updatePreview);

        // ダウンロードボタンが押されたら起動
        function downloadFile() {
            // const blobx = new Blob(["Hello, world!"], {type: "text/plain;charset=utf-8"});
            // saveAs(blobx, "hello world.txt");  
            console.log('file dlownloading');

            const codes = getCodes();

            // HTML ファイルダウンロード
            const date = new Date()
            const y = date.getFullYear()
            const m = date.getMonth() +1
            const d = date.getDate()

            const filename = `mycode-${y}${m}${d}.html`;

            const bom  = new Uint8Array([0xEF, 0xBB, 0xBF]); // UTF-8だと示すためのバイトオーダーマーク
            const blob = new Blob([ bom, codes.doc ], { "type" : "text/html" });
            saveAs(blob, filename);   
            // blobx→blobというプロジェクト。バイナリーデータ（コンピュータが読めるデータのこと）。

            // IMG ファイルダウンロード
            // 考え中
        }

        // ダウンロードリンクが押されたら起動
        document.getElementById("downloadButton").addEventListener("click", downloadFile);
    </script>
</body>

</html>
